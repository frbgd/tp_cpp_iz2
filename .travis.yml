language: cpp
dist: bionic
sudo: true
compiler: gcc

addons:
  apt:
    packages:
      - cmake
      - cppcheck
      - valgrind
      - python3
      - python3-pip

before_script:
  - pip3 install cpplint
  - mkdir build && cd build
  - cmake ..
  - make
  - cp ../tests/test_data* .

jobs:
  include:
    - stage: static_analisys
      name: "Static analisys"
      script:
        - cppcheck --inconclusive --enable=all --language=c ../include/* ../src/*.c ../tests/*.c
        - cppcheck --inconclusive --enable=all --language=c++ ../tests/*.cpp
        - cpplint --headers=h --linelength=110 --filter=-runtime/int,-legal/copyright,-build/include_subdir,-build/include --extensions=cpp,h ../tests/*

    - stage: stress_test
      name: "Run stress test"
      script:
        - ./stress_test

    - stage: unit_tests
      name: "Run unit tests"
      script:
        - ./static_lib_tests
        - ./dynamic_lib_tests

    - stage: memcheck
      name: "Memory checking"
      script:
        - valgrind --leak-check=full --leak-resolution=med --track-origins=yes --vgdb=no ./stress_test
        - valgrind --leak-check=full --leak-resolution=med --track-origins=yes --vgdb=no ./static_lib_tests
        - valgrind --leak-check=full --leak-resolution=med --track-origins=yes --vgdb=no ./dynamic_lib_tests

after_success:
  - bash <(curl -s https://codecov.io/bash)
